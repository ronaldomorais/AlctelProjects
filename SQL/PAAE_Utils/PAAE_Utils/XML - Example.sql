USE AlctelVSS
GO



/*

<?xml version="1.0"?>
<chatTranscript startAt="2023-03-07T14:42:03Z" sessionId="00018aJ04EU937T8">
	<newParty userId="009464074D3BF67C" timeShift="0" visibility="ALL" eventId="1">
		<userInfo personId="" userNick="Sem  nome" userType="CLIENT" protocolType="FLEX" timeZoneOffset="-120" clientVersion="106"/>
		<userData>
			<item key="Alc_Nav_Associado" type="string">0</item>
			<item key="FirstName" type="string">Sem </item>
			<item key="IdentificacaoCliente" type="string">0</item>
			<item key="IdentifyCreateContact" type="string">3</item>
			<item key="LastName" type="string">nome</item>
			<item key="MediaType" type="string">chat</item>
			<item key="Origem" type="string">Chat</item>
			<item key="TimeZone" type="string">-120</item>
			<item key="phone" type="string">725fe96a-60b6-4a0c-ade4-a212aedb24a2</item>
			<item key="subject" type="string">Chat_Cliente</item>
		</userData>
	</newParty>
	<message userId="009464074D3BF67C" timeShift="1" visibility="ALL" eventId="2">
		<msgText>[Historico - Bot] - Oi, tudo bem? ?? Meu nome é Denise, assistente virtual da DM e vou te ajudar! [Historico - Bot] - ?? *A DM não entra em contato por redes sociais ou WhatsApp* ofertando aumento de limite ou pedindo dados do seu cartão.  Se isso acontecer, *bloqueie o contato e não passe nenhuma informação* sua, combinado?  Agora, vamos lá! [Historico - Usuario] - lojista [Historico - Bot] - Legal!!  Digite a chave da loja [Historico - Usuario] - 65432 [Historico - Usuario] - sim [Historico - Usuario] - 2 </msgText>
	</message>
	<message userId="009464074D3BF67C" timeShift="2" visibility="ALL" eventId="3">
		<msgText>Você vai atender:  Categoria: Lojista Loja: SPANI ATACADISTA Chave: 65432 Assunto: Outros Assuntos&lt;br&gt;Token validado: Não  Bom atendimento ??</msgText>
	</message>
	<newParty userId="009464074DB1F69E" timeShift="118" visibility="ALL" eventId="4">
		<userInfo personId="62408" userNick="Karoline" userType="AGENT" protocolType="BASIC" timeZoneOffset="-180" clientVersion="106"/>
	</newParty>
	<message userId="009464074D3BF67C" timeShift="130" visibility="ALL" eventId="6">
		<msgText>bom dia   .....</msgText>
	</message>
	<message userId="009464074DB1F69E" timeShift="131" visibility="ALL" eventId="7">
		<msgText treatAs="NORMAL">Olá tudo bem? Meu nome é Karoline, vou te atender a partir de agora. Falo com quem?</msgText>
	</message>
	<message userId="009464074D3BF67C" timeShift="133" visibility="ALL" eventId="8">
		<msgText>daniela</msgText>
	</message>
	<message userId="009464074D3BF67C" timeShift="140" visibility="ALL" eventId="9">
		<msgText>daniela</msgText>
	</message>
	<message userId="009464074D3BF67C" timeShift="150" visibility="ALL" eventId="10">
		<msgText>por favor a cliente mudou o telefone </msgText>
	</message>
	<message userId="009464074D3BF67C" timeShift="155" visibility="ALL" eventId="11">
		<msgText>por fasvor troca pra mim </msgText>
	</message>
	<message userId="009464074D3BF67C" timeShift="158" visibility="ALL" eventId="12">
		<msgText> MARIA DE FATIMA DE MOURA E SILVA CPF: 086.876.638-03 Tel Res: (12) 99791-8265 Celular: (12) 99707-0277 Tel Comercial: Endereços End. Residencial: RUA MANOEL DE CASTRO NOGUEIRA, 277 - JARDIM DO VALE II - 12519-500 - GUARATINGUETA - SP Aceito os seguintes serviços, cobrados na minha fatura: Seguro Proteção Premiavel, EcoFa</msgText>
	</message>
	<message userId="009464074DB1F69E" timeShift="203" visibility="ALL" eventId="14">
		<msgText treatAs="NORMAL">Cliente esta em loja?</msgText>
	</message>
	<message userId="009464074D3BF67C" timeShift="215" visibility="ALL" eventId="15">
		<msgText>sim</msgText>
	</message>
	<message userId="009464074DB1F69E" timeShift="224" visibility="ALL" eventId="17">
		<msgText treatAs="NORMAL"> Segue o protocolo deste atendimento por favor, é o numero 2066929837</msgText>
	</message>
	<message userId="009464074D3BF67C" timeShift="236" visibility="ALL" eventId="18">
		<msgText>ok</msgText>
	</message>
	<message userId="009464074DB1F69E" timeShift="280" visibility="ALL" eventId="20">
		<msgText treatAs="NORMAL">Por motivos de segurança é necessário confirmar alguns dados    - Nome da mãe - Possui cartão adicional - telefone novo com o ddd  Por favor ??</msgText>
	</message>
	<message userId="009464074D3BF67C" timeShift="314" visibility="ALL" eventId="21">
		<msgText>nao tem adicional</msgText>
	</message>
	<message userId="009464074D3BF67C" timeShift="329" visibility="ALL" eventId="22">
		<msgText>12991110377</msgText>
	</message>
	<message userId="009464074DB1F69E" timeShift="383" visibility="ALL" eventId="24">
		<msgText treatAs="NORMAL">Qual a data de nascimento?</msgText>
	</message>
	<message userId="009464074D3BF67C" timeShift="442" visibility="ALL" eventId="25">
		<msgText>mae tereza  maria pereira de mouira</msgText>
	</message>
	<message userId="009464074D3BF67C" timeShift="452" visibility="ALL" eventId="26">
		<msgText>26/061959</msgText>
	</message>
	<message userId="009464074D3BF67C" timeShift="482" visibility="ALL" eventId="27">
		<msgText>26/06/1959</msgText>
	</message>
	<message userId="009464074DB1F69E" timeShift="533" visibility="ALL" eventId="29">
		<msgText treatAs="NORMAL">Obrigada pelas confirmações, só um momento por favor.</msgText>
	</message>
	<message userId="009464074D3BF67C" timeShift="557" visibility="ALL" eventId="30">
		<msgText>ok[]3</msgText>
	</message>
	<message userId="009464074DB1F69E" timeShift="613" visibility="ALL" eventId="32">
		<msgText treatAs="NORMAL">Obrigada por aguardar vou te transferir para o setor responsavel um momento.</msgText>
	</message>
	<message userId="009464074D3BF67C" timeShift="617" visibility="ALL" eventId="33">
		<msgText>ok</msgText>
	</message>
	<partyLeft userId="009464074DB1F69E" timeShift="625" visibility="ALL" eventId="34" askerId="009464074DB1F69E">
		<reason>left</reason>
		<eventAttributes>
			<item key="general-properties" type="kvlist">
				<item key="reason-for-leave" type="string">TRANSFER</item>
			</item>
		</eventAttributes>
	</partyLeft>
	<message userId="009464074D3BF67C" timeShift="627" visibility="ALL" eventId="35">
		<msgText>ok[</msgText>
	</message>
	<message userId="009464074D3BF67C" timeShift="821" visibility="ALL" eventId="36">
		<msgText>ok</msgText>
	</message>
	<message userId="009464074D3BF67C" timeShift="901" visibility="ALL" eventId="37">
		<msgText>ok</msgText>
	</message>
	<newParty userId="0094640750F8F7B0" timeShift="957" visibility="ALL" eventId="38">
		<userInfo personId="62374" userNick="Gislaine" userType="AGENT" protocolType="BASIC" timeZoneOffset="-180" clientVersion="106"/>
	</newParty>
	<message userId="009464074D3BF67C" timeShift="971" visibility="ALL" eventId="39">
		<msgText>bom dia </msgText>
	</message>
	<message userId="0094640750F8F7B0" timeShift="977" visibility="ALL" eventId="41">
		<msgText treatAs="NORMAL"> Oi, que bom ter você aqui! Meu nome é Gislaine e vou te atender a partir de agora. Com quem eu falo?    </msgText>
	</message>
	<message userId="009464074D3BF67C" timeShift="988" visibility="ALL" eventId="42">
		<msgText>daniela</msgText>
	</message>
	<message userId="009464074D3BF67C" timeShift="1008" visibility="ALL" eventId="43">
		<msgText>ok</msgText>
	</message>
	<message userId="0094640750F8F7B0" timeShift="1025" visibility="ALL" eventId="45">
		<msgText treatAs="NORMAL">(12) 99791-8265    Celular: (12) 99707-0277    qual numero atual?</msgText>
	</message>
	<message userId="009464074D3BF67C" timeShift="1046" visibility="ALL" eventId="46">
		<msgText>12991110377 este novo</msgText>
	</message>
	<message userId="009464074D3BF67C" timeShift="1066" visibility="ALL" eventId="48">
		<msgText>(12) 99791-8265 Celular: (12) 99707-0277 qual numero atual? este nao exite mais </msgText>
	</message>
	<message userId="0094640750F8F7B0" timeShift="1067" visibility="ALL" eventId="49">
		<msgText treatAs="NORMAL">Favor enviar foto da cliente com documento ao lado rosto</msgText>
	</message>
	<message userId="009464074D3BF67C" timeShift="1126" visibility="ALL" eventId="50">
		<msgText>so minuto[</msgText>
	</message>
	<message userId="0094640750F8F7B0" timeShift="1361" visibility="ALL" eventId="52">
		<msgText treatAs="NORMAL">estamos aguardando</msgText>
	</message>
	<message userId="009464074D3BF67C" timeShift="1440" visibility="ALL" eventId="53">
		<msgText>ja  enviei</msgText>
	</message>
	<message userId="009464074D3BF67C" timeShift="1681" visibility="ALL" eventId="54">
		<msgText>???????</msgText>
	</message>
	<message userId="009464074D3BF67C" timeShift="1683" visibility="ALL" eventId="55">
		<msgText>???</msgText>
	</message>
	<message userId="0094640750F8F7B0" timeShift="1850" visibility="ALL" eventId="57">
		<msgText treatAs="NORMAL">estou verificando</msgText>
	</message>
	<message userId="0094640750F8F7B0" timeShift="1876" visibility="ALL" eventId="59">
		<msgText treatAs="NORMAL">foto da cliente deve ser em loja</msgText>
	</message>
	<message userId="009464074D3BF67C" timeShift="1904" visibility="ALL" eventId="60">
		<msgText>Sistema: Atendimento Encerrado pelo usuário</msgText>
	</message>
	<partyLeft userId="0094640750F8F7B0" timeShift="1947" visibility="ALL" eventId="61" askerId="0094640750F8F7B0">
		<reason code="1">left with request to close if no agents</reason>
	</partyLeft>
	<partyLeft userId="009464074D3BF67C" timeShift="1947" visibility="ALL" eventId="62" askerId="0094640750F8F7B0">
		<reason code="4">removed by other party</reason>
	</partyLeft>
</chatTranscript>

*/


ALTER PROCEDURE [dbo].[TESTE_Alc_Paae_011_sp_buscaHistorico] 
	@Id NVARCHAR(16) = '00018aJ04EU937T8',
	@Mediatypeid NVARCHAR(16) = 'CHAT'
AS
BEGIN
	SET NOCOUNT ON;
	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

	DECLARE
		@interaction_id NVARCHAR(16) = @Id
		,@media_type_id NVARCHAR(16) = @Mediatypeid
		,@X AS XML
		,@chat_start_at_gmt DATETIME
		,@chat_start_at DATETIME
		,@chat_id NVARCHAR(16)

	IF OBJECT_ID('tempdb..#tInteractions') IS NOT NULL
		DROP TABLE #tInteractions
	IF OBJECT_ID('tempdb..#tChatParticipants') IS NOT NULL
		DROP TABLE #tChatParticipants
	IF OBJECT_ID('tempdb..#tChatMessages') IS NOT NULL
		DROP TABLE #tChatMessages


	SELECT 
		S.Id
		,S.StructuredText
	INTO #tInteractions
	FROM (

		SELECT 
			Id
			,StructuredText
		FROM [Alctel_Gen_UCS].[dbo].[Interaction] 
		WHERE
			Id = @interaction_id
			AND MediaTypeId = @media_type_id

		UNION ALL

		SELECT 
			Id
			,StructuredText
		FROM [Alctel_Gen_UCSA].[dbo].[Interaction] 
		WHERE
			Id = @interaction_id
			AND MediaTypeId = @media_type_id

	) AS S

	SET @X = (SELECT StructuredText FROM #tInteractions)

	SELECT 
		@chat_id = T.c.value('@sessionId', 'NVARCHAR(16)') 
		,@chat_start_at_gmt = T.c.value('@startAt', 'DATETIME')
	FROM @X.nodes('chatTranscript') T(c)

	SET @chat_start_at = DATEADD(HOUR, -3, @chat_start_at_gmt)

	SELECT 
		--T.c.query('.') AS Result
		T.c.value('@timeShift', 'INT') AS time_shift
		,T.c.value('@userId', 'VARCHAR(255)') AS chat_user_id
		,T.c.value('(userInfo/@personId)[1]', 'VARCHAR(255)') AS agent_id
	INTO #tChatParticipants
	FROM @X.nodes('/chatTranscript/newParty') T(c)


	SELECT 
		--T.c.query('.') AS Result
		T.c.value('@timeShift', 'INT') AS time_shift
		,T.c.value('@userId', 'VARCHAR(255)') AS chat_user_id
		,T.c.value('msgText[1]', 'VARCHAR(255)') AS message_text
	INTO #tChatMessages
	FROM @X.nodes('/chatTranscript/message') T(c)



	SELECT
		--ROW_NUMBER() OVER(ORDER BY M.time_shift) AS ordem
		UPPER(@chat_id) AS Id
		--,M.time_shift
		,DATEADD(SECOND, M.time_shift, @chat_start_at) AS dataHoraInteracao
		,M.chat_user_id
		--,P.time_shift
		,M.message_text AS msgHistoricoChat
		,P.agent_id AS agente
		,CASE WHEN P.agent_id = '' THEN '[Usuário] Sem nome' ELSE CONCAT('[Agente] ', A.first_name, ' ', A.last_name) END AS agenteUsuario
	FROM #tChatMessages AS M
		LEFT JOIN #tChatParticipants AS P ON M.chat_user_id = P.chat_user_id
		LEFT JOIN Alctel_Gen_CONFIG..cfg_person AS A ON P.agent_id = A.employee_id
	ORDER BY M.time_shift


END